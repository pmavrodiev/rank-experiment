// Generated by CoffeeScript 1.3.3
(function() {

  window.rank_experiment = (function() {

    function rank_experiment() {
      this.compositeG = document.getElementById("svgCanvas");
      this.circleCanvas = document.getElementById("circleCanvas");
      /*
          @majorCircle=document.getElementById("majorCircle") 
          @targetCircle=document.getElementById("targetCircle") 
          @currentGuess=document.getElementById("currentGuess") 
          @angleLine=document.getElementById("angleLine") 
          @rankText=document.getElementById("rankText")
          @angleText=document.getElementById("angleText")
          @msgText=document.getElementById("msgText")
         
      
          @radius = 480
          @viewport_size=1050
          @viewport_axis_x = 525 #the translated x axis of the <g> component in svgcanvas.html
          @viewport_axis_y = 490 #the translated y axis of the <g> component in svgcanvas.html
          @centre_coord=circleCanvas.createSVGPoint()
      
          @zoom_scale = 0.2
          
          @previous_angle = Math.PI/2
        
          @rankTextOpacity = 1  
          @timedHover
          @isMacWebKit = navigator.userAgent.indexOf("Macintosh") != -1 &&
                      navigator.userAgent.indexOf("WebKit") != -1
                      
          @isFirefox = navigator.userAgent.indexOf("Gecko") != -1
          
          window.addEventListener('load',@windowListen(),false)
      */

      window.addEventListener('load', this.windowListen2(), false);
    }

    rank_experiment.prototype.windowListen2 = function() {
      var animateRankText, ccMouseClick2, ccMouseMove2, getCursorPosition2, init, init_canvas, update_zoom,
        _this = this;
      getCursorPosition2 = function(e) {
        var pt, pt2, transformation_matrix;
        pt = _this.circleCanvas.createSVGPoint();
        pt.x = e.x;
        pt.y = e.y;
        transformation_matrix = _this.compositeG.getScreenCTM();
        pt2 = pt.matrixTransform(transformation_matrix.inverse());
        return pt2;
      };
      ccMouseClick2 = function(e) {
        var coord, p, p2, p3, p4, p5, s, tm, tmparent, translation_x, translation_y, zoom;
        coord = getCursorPosition2(e);
        tm = _this.compositeG.getScreenCTM();
        tmparent = _this.circleCanvas.getScreenCTM();
        p = _this.circleCanvas.createSVGMatrix();
        p2 = p.translate(coord.x, coord.y);
        p3 = p2.scale(1.33);
        p4 = p3.translate(-coord.x / 1.33, -coord.y / 1.33);
        p5 = tm.multiply(p4);
        zoom = 1 + 2 * tm.a;
        translation_x = tm.e;
        translation_y = tm.f + zoom * coord.y;
        s = "matrix(" + zoom + "," + tm.b + "," + tm.c + "," + (-zoom) + "," + translation_x + "," + translation_y + ")";
        return _this.compositeG.setAttribute("transform", s);
      };
      ccMouseMove2 = function(e) {
        var coord;
        coord = getCursorPosition2(e);
        return console.log(e.x + ":" + e.y + ":::" + coord.x + ":" + coord.y);
      };
      animateRankText = function() {};
      update_zoom = function() {
        /*
              viewport.setAttribute("transform",
                                      "translate("+ centre_coord.x+","+ centre_coord.y +") "+
                    "scale("+zoom_positions[zoom_level]+","+(-zoom_positions[zoom_level])+")")
        */

      };
      init_canvas = function() {
        return update_zoom();
      };
      init = function() {
        _this.zoom_level = 0.2;
        _this.compositeG.addEventListener('mousemove', ccMouseMove2, false);
        _this.compositeG.addEventListener('click', ccMouseClick2, false);
        return init_canvas();
      };
      return init();
    };

    rank_experiment.prototype.windowListen = function() {
      var animateRankText, ccMouseClick, ccMouseMove, ccMouseWheel, getCursorPosition, init, init_canvas, restartGuessingTask, update_zoom,
        _this = this;
      getCursorPosition = function(e) {
        var pt, pt2, transformation_matrix;
        pt = _this.circleCanvas.createSVGPoint();
        pt.x = e.x;
        pt.y = e.y;
        transformation_matrix = _this.compositeG.getScreenCTM();
        pt2 = pt.matrixTransform(transformation_matrix.inverse());
        return pt2;
      };
      ccMouseWheel = function(event) {
        var coord, deltaX, deltaY, e, k, km, km_scaled, km_scaled_zoomed, km_scaled_zoomed_translated, m, s, sgn, tm, zoom;
        sgn = function(x) {
          if (x > 0) {
            return 1;
          } else if (x < 0) {
            return -1;
          } else {
            return 0;
          }
        };
        e = event || window.event;
        coord = getCursorPosition(e);
        deltaX = e.deltaX * -30 || e.wheelDeltaX / 40 || 0;
        deltaY = e.deltaY * -30 || e.wheelDeltaY / 109 || (e.wheelDeltaY === void 0 && e.wheelDelta / 109) || e.detail * -10 || 0;
        if (deltaY > 0) {
          _this.zoom_level++;
        }
        if (deltaY < 0) {
          _this.zoom_level--;
        }
        /*  
        Most browsers generate one event with delta 120 per mousewheel click.
        On Macs, however, the mousewheels seem to be velocity-sensitive and
             the delta values are often larger multiples of 120, at
        least with the Apple Mouse. Use browser-testing to defeat this.
        */

        if (_this.isMacWebKit) {
          deltaX /= 30;
          deltaY /= 30;
        }
        if (_this.isFirefox && e.type !== "DOMMouseScroll") {
          _this.circleCanvas.removeEventListener("DOMMouseScroll", ccMouseWheel, false);
        }
        zoom = Math.pow(1 + _this.zoom_scale, deltaY);
        km = _this.circleCanvas.createSVGMatrix();
        km_scaled = km.translate(coord.x, coord.y);
        km_scaled_zoomed = km_scaled.scaleNonUniform(zoom, zoom);
        km_scaled_zoomed_translated = km_scaled_zoomed.translate(-coord.x, -coord.y);
        k = km_scaled_zoomed_translated;
        tm = _this.circleCanvas.getCTM();
        m = tm.multiply(k);
        s = "matrix(" + m.a + "," + m.b + "," + m.c + "," + m.d + "," + m.e + "," + m.f + ")";
        _this.circleCanvas.setAttribute("transform", s);
        return false;
      };
      ccMouseClick = function(e) {
        var coord;
        coord = getCursorPosition(e);
        _this.previous_angle = Math.atan2(coord.y, coord.x);
        _this.currentGuess.setAttribute("cx", _this.radius * Math.cos(_this.previous_angle));
        _this.currentGuess.setAttribute("cy", _this.radius * Math.sin(_this.previous_angle));
        _this.circleCanvas.getElementsByTagName('animate')[0].beginElement();
        _this.circleCanvas.removeEventListener('mousemove', ccMouseMove);
        _this.circleCanvas.removeEventListener('click', ccMouseClick);
        _this.msgText.textContent = "Wait for your opponents to guess...";
        _this.msgText.style.fill = "green";
        _this.rankTextOpacity = 1;
        animateRankText();
        return setTimeout(restartGuessingTask, 4000);
      };
      ccMouseMove = function(e) {
        var angle, box, coord;
        coord = getCursorPosition(e);
        angle = Math.atan2(coord.y, coord.x);
        _this.angleLine.setAttribute("x2", _this.radius * Math.cos(angle));
        _this.angleLine.setAttribute("y2", _this.radius * Math.sin(angle));
        _this.targetCircle.setAttribute("cx", _this.radius * Math.cos(angle));
        _this.targetCircle.setAttribute("cy", _this.radius * Math.sin(angle));
        console.log(coord.x + ":" + coord.y + ":" + angle);
        return box = _this.circleCanvas.getBBox();
      };
      animateRankText = function() {};
      restartGuessingTask = function() {
        _this.rankText.textContent = "Your new rank is: " + Math.ceil(Math.random() * 20);
        _this.rankText.style.fill = "black";
        _this.rankTextOpacity = 1;
        animateRankText();
        _this.zoom_level = 0;
        _this.circleCanvas.addEventListener('mousemove', ccMouseMove, false);
        return _this.circleCanvas.addEventListener('click', ccMouseClick, false);
      };
      update_zoom = function() {
        /*
              viewport.setAttribute("transform",
                                      "translate("+ centre_coord.x+","+ centre_coord.y +") "+
                    "scale("+zoom_positions[zoom_level]+","+(-zoom_positions[zoom_level])+")")
        */

      };
      init_canvas = function() {
        _this.centre_coord.x = _this.viewport_axis_x;
        _this.centre_coord.y = _this.viewport_axis_y;
        return update_zoom();
      };
      init = function() {
        _this.zoom_level = 0.2;
        _this.circleCanvas.addEventListener('click', ccMouseClick2, false);
        _this.rankText.textContent = "";
        return init_canvas();
      };
      return init();
    };

    return rank_experiment;

  })();

}).call(this);
